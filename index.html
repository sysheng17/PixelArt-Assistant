<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒå‹•å°é®ç•«ä½œåŠ©æ‰‹</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <style>
        :root { --primary: #6366f1; --success: #10b981; --bg: #f8fafc; --reset: #94a3b8; --danger: #f43f5e; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); padding: 20px; color: #1e293b; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); position: relative; }
        
        .lang-switch { position: absolute; top: 20px; right: 25px; }
        .lang-btn { background: #e2e8f0; padding: 5px 12px; border-radius: 15px; font-weight: bold; font-size: 0.8rem; border: 2px solid transparent; cursor: pointer; }
        .lang-btn.active { border-color: var(--primary); background: #fff; color: var(--primary); }

        .edit-layout { display: grid; grid-template-columns: 1fr 380px; gap: 25px; margin-top: 20px; }
        @media (max-width: 900px) { .edit-layout { grid-template-columns: 1fr; } }

        .img-container { max-height: 400px; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 15px; }
        #imageToCrop { max-width: 100%; }

        .canvas-area { background: #e2e8f0; border-radius: 12px; display: flex; align-items: center; justify-content: center; padding: 20px; min-height: 500px; overflow: auto; }
        canvas { image-rendering: pixelated; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }

        .panel { display: flex; flex-direction: column; gap: 15px; }
        .group { border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; background: #fff; }
        h3 { font-size: 0.85rem; margin: 0 0 10px 0; color: #64748b; border-left: 4px solid var(--primary); padding-left: 10px; }

        .grid-matrix { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-bottom: 10px; }
        .ratio-tag { grid-column: span 4; font-size: 0.7rem; font-weight: bold; color: var(--primary); background: #f1f5f9; padding: 2px 8px; border-radius: 4px; margin-top: 5px; }
        
        button { cursor: pointer; border: none; padding: 6px 4px; border-radius: 4px; font-size: 0.75rem; background: #f1f5f9; transition: 0.2s; }
        button:hover { background: #e2e8f0; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; width: 100%; padding: 12px; font-weight: bold; margin-bottom: 8px; border-radius: 8px; }
        .btn-reset { background: var(--reset); color: white; width: 100%; margin-top: 5px; }

	
        /* é€è‰²æ¨¡å¼æŒ‰éˆ•æ¨£å¼ */
        .color-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; max-height: 180px; overflow-y: auto; padding: 5px; }
        .color-item { 
    width: 38px; 
    height: 38px; 
    font-size: 11px; 
    font-weight: bold; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    color: #fff; 
    text-shadow: 1px 1px 2px #000, -1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000; /* å…¨æ–¹ä½é™°å½± */
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.2);
    cursor: pointer;
    transition: transform 0.1s;
}
        .color-item:hover { transform: scale(1.1); }
        .color-item.active { outline: 3px solid var(--primary); transform: scale(0.9); outline-offset: 2px; border-color: #fff; z-index: 1; }

        .custom-input { display: flex; align-items: center; gap: 5px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e2e8f0; }
        input[type="number"] { width: 60px; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; }
        
        #limitWarning { color: var(--danger); font-size: 0.75rem; font-weight: bold; margin-top: 5px; height: 18px; opacity: 0; transition: opacity 0.3s; }
        .hint { font-size: 0.7rem; color: #94a3b8; }
    </style>
</head>
<body>

<div class="container">
    <div class="lang-switch">
        <button class="lang-btn active" onclick="switchLang('zh', event)">ä¸­æ–‡</button>
        <button class="lang-btn" onclick="switchLang('en', event)">EN</button>
    </div>

    <h2 id="ui-title" style="text-align:center;">ğŸ¨ å¿ƒå‹•å°é®ç•«ä½œåŠ©æ‰‹</h2>

    <div id="step1">
        <div style="text-align: center; border: 2px dashed #cbd5e1; padding: 30px; border-radius: 12px; margin-bottom: 20px;">
            <input type="file" id="upload" accept="image/*">
        </div>
        <div class="img-container"><img id="imageToCrop"></div>
        <div id="cropControls" style="display:none; text-align:center;">
            <div style="margin-bottom:15px; display:flex; gap:5px; justify-content:center; flex-wrap:wrap;">
                <button onclick="setRatio(16/9)">16:9</button>
                <button onclick="setRatio(4/3)">4:3</button>
                <button onclick="setRatio(1/1)">1:1</button>
                <button onclick="setRatio(3/4)">3:4</button>
                <button onclick="setRatio(9/16)">9:16</button>
            </div>
            <button class="btn-primary" id="ui-confirm-crop" style="padding:10px 50px; border-radius:20px;" onclick="confirmCrop()">ç¢ºèªå‰ªè£</button>
        </div>
    </div>

    <div id="step2" class="edit-layout" style="display:none;">
        <div class="canvas-area">
            <canvas id="mainCanvas"></canvas>
        </div>

        <div class="panel">
            <div class="group">
                <h3 id="ui-h-size">1. å¸¸ç”¨å°ºå¯¸</h3>
                <div class="grid-matrix">
                    <div class="ratio-tag">16 : 9</div>
                    <button onclick="safeMosaic(30,18)">30x18</button><button onclick="safeMosaic(50,28)">50x28</button>
                    <button onclick="safeMosaic(100,56)">100x56</button><button onclick="safeMosaic(150,84)">150x84</button>
                    <div class="ratio-tag">4 : 3</div>
                    <button onclick="safeMosaic(30,24)">30x24</button><button onclick="safeMosaic(50,38)">50x38</button>
                    <button onclick="safeMosaic(100,76)">100x76</button><button onclick="safeMosaic(150,114)">150x114</button>
                    <div class="ratio-tag">1 : 1</div>
                    <button onclick="safeMosaic(30,30)">30x30</button><button onclick="safeMosaic(50,50)">50x50</button>
                    <button onclick="safeMosaic(100,100)">100x100</button><button onclick="safeMosaic(150,150)">150x150</button>
                    <div class="ratio-tag">3 : 4</div>
                    <button onclick="safeMosaic(24,30)">24x30</button><button onclick="safeMosaic(38,50)">38x50</button>
                    <button onclick="safeMosaic(76,100)">76x100</button><button onclick="safeMosaic(114,150)">114x150</button>
                    <div class="ratio-tag">9 : 16</div>
                    <button onclick="safeMosaic(18,30)">18x30</button><button onclick="safeMosaic(28,50)">28x50</button>
                    <button onclick="safeMosaic(56,100)">56x100</button><button onclick="safeMosaic(84,150)">84x150</button>
                </div>
                <div class="custom-input">
                    <input type="number" id="customW" placeholder="W"> Ã— <input type="number" id="customH" placeholder="H">
                    <button class="btn-primary" id="ui-apply-btn" onclick="applyCustom()">å¥—ç”¨</button>
                </div>
                <div id="limitWarning">âš ï¸ å·²è‡ªå‹•ä¿®æ­£ç‚ºåŸåœ–å°ºå¯¸ä¸Šé™</div>
                <div id="maxHint" class="hint"></div>
                <label style="font-size:0.8rem; margin-top:10px; display:block;"><input type="checkbox" id="showGrid" onchange="render()" checked> <span id="ui-grid-label">é¡¯ç¤ºåƒè€ƒç¶²æ ¼</span></label>
            </div>
               

            <div class="group">
                <h3 id="ui-h-color">2. è‰²å½©è™•ç†æ¨¡å¼</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px;">
                    <button class="btn-primary" style="grid-column: span 2;" id="ui-town-direct" onclick="applyPalette('town', false)">å°é® 125è‰² (ç›´æ¥)</button>
                    <button class="btn-primary" style="grid-column: span 2;" id="ui-town-dither" onclick="applyPalette('town', true)">å°é® 125è‰² (æŠ–å‹•)</button>
                    <button onclick="applyPalette('256', false)" id="ui-256">æ¨™æº– 256 è‰²</button>
                    <button onclick="applyPalette('16', false)" id="ui-16">å¾©å¤ 16 è‰²</button>
                    <button class="btn-reset" style="grid-column: span 2;" id="ui-reset-btn" onclick="resetColors()">ğŸ”„ é‡ç½®åŸå§‹è‰²å½©</button>
                </div>
            </div>

            <div class="group">
                <h3 id="ui-h-step">3. é€è‰²æ¨¡å¼(é¸ç”¨) #æ ¼å¼ï¼š7-3 æ˜¯ç¬¬7çµ„ç¬¬3å€‹é¡è‰²</h3>
                <button onclick="filterColor(null)" style="width:100%; margin-bottom:8px;" id="ui-show-all">é¡¯ç¤ºå…¨éƒ¨é¡è‰²</button>
                <div id="colorPickerList" class="color-list"></div>
            </div>

            <div class="group">
                <h3 id="ui-h-export">4. å°å‡º</h3>
                <button class="btn-success" id="ui-dl-pure" onclick="downloadImage(false)">ğŸ’¾ ä¸‹è¼‰ç´”æ·¨åƒç´ åœ–</button>
                <button class="btn-success" style="background:#64748b;" id="ui-dl-grid" onclick="downloadImage(true)">ğŸ“ ä¸‹è¼‰å¸¶ç¶²æ ¼åƒè€ƒåœ–</button>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 20px; padding: 15px; border-radius: 12px; background: #fffaf0; border: 1px dashed #ffb7b2; text-align: center;">
        <strong style="font-size: 0.85rem; color: #d63031;">â˜• æ”¯æŒæˆ‘ (Support Me)</strong>
        <p style="font-size: 0.75rem; color: #636e72; margin: 8px 0;">
            <a href="https://forms.gle/v8TYdQW9VzEBVacA7" target="_blank">Feedback & Suggestions Form / å•é¡Œ&å»ºè­°å›é¥‹è¡¨å–®</a><br>
            å¦‚æœä½ è¦ºå¾—é€™å€‹å·¥å…·æœ‰å¹«åŠ©ï¼Œå¯ä»¥è«‹æˆ‘å–æ¯å’–å•¡ï¼<br>
            If you find this tool helpful, feel free to buy me a coffee!
        </p>
        <a href="https://ko-fi.com/shenlyway" target="_blank" style="display: inline-block;">
            <img src="https://ko-fi.com/img/githubbutton_sm.svg" alt="ko-fi" style="height: 32px; vertical-align: middle;">
        </a>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
    const i18n = {
        zh: {
            title: "ğŸ¨ å¿ƒå‹•å°é®ç•«ä½œåŠ©æ‰‹",
            confirmCrop: "ç¢ºèªå‰ªè£",
            hSize: "1. å¸¸ç”¨å°ºå¯¸",
            apply: "å¥—ç”¨",
            limit: "âš ï¸ å·²è‡ªå‹•ä¿®æ­£ç‚ºåŸåœ–å°ºå¯¸ä¸Šé™",
            maxHint: "* åŸåœ–åƒç´ æ¥µé™: ",
            grid: "é¡¯ç¤ºåƒè€ƒç¶²æ ¼",
            hColor: "2. è‰²å½©è™•ç†æ¨¡å¼",
            townDirect: "å°é® 125è‰² (ç›´æ¥)",
            townDither: "å°é® 125è‰² (æŠ–å‹•)",
            c256: "æ¨™æº– 256 è‰²",
            c16: "å¾©å¤ 16 è‰²",
            reset: "ğŸ”„ é‡ç½®åŸå§‹è‰²å½©",
            hStep: "3. é€è‰²æ¨¡å¼(é¸ç”¨) #ä¾‹ï¼š7-3 æ˜¯ç¬¬7çµ„ç¬¬3å€‹é¡è‰²",
            showAll: "é¡¯ç¤ºå…¨éƒ¨é¡è‰²",
            hExport: "4. å°å‡º",
            dlPure: "ğŸ’¾ ä¸‹è¼‰ç´”æ·¨åƒç´ åœ–",
            dlGrid: "ğŸ“ ä¸‹è¼‰å¸¶ç¶²æ ¼åƒè€ƒåœ–"
        },
        en: {
            title: "ğŸ¨ Town Art Assistant",
            confirmCrop: "Confirm Crop",
            hSize: "1. Common Sizes",
            apply: "Apply",
            limit: "âš ï¸ Limited to original image size",
            maxHint: "* Original Limit: ",
            grid: "Show Grid Lines",
            hColor: "2. Color Processing",
            townDirect: "Town 125 (Direct)",
            townDither: "Town 125 (Dither)",
            c256: "Web 256 Color",
            c16: "Retro 16 Color",
            reset: "ğŸ”„ Reset to Original",
            hStep: "3. Step-by-Step Mode (Optional) #e.g., 7-3 is Group 7, 3rd color.",
            showAll: "Show All Colors",
            hExport: "4. Export",
            dlPure: "ğŸ’¾ Download Pixel Art",
            dlGrid: "ğŸ“ Download with Grid"
        }
    };

    let currentLang = 'zh';
    let targetColor = null;

    function switchLang(lang, e) {
        currentLang = lang;
        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        
        const t = i18n[lang];
        document.getElementById('ui-title').innerText = t.title;
        document.getElementById('ui-confirm-crop').innerText = t.confirmCrop;
        document.getElementById('ui-h-size').innerText = t.hSize;
        document.getElementById('ui-apply-btn').innerText = t.apply;
        document.getElementById('limitWarning').innerText = t.limit;
        document.getElementById('ui-grid-label').innerText = t.grid;
        document.getElementById('ui-h-color').innerText = t.hColor;
        document.getElementById('ui-town-direct').innerText = t.townDirect;
        document.getElementById('ui-town-dither').innerText = t.townDither;
        document.getElementById('ui-256').innerText = t.c256;
        document.getElementById('ui-16').innerText = t.c16;
        document.getElementById('ui-reset-btn').innerText = t.reset;
        document.getElementById('ui-h-step').innerText = t.hStep;
        document.getElementById('ui-show-all').innerText = t.showAll;
        document.getElementById('ui-h-export').innerText = t.hExport;
        document.getElementById('ui-dl-pure').innerText = t.dlPure;
        document.getElementById('ui-dl-grid').innerText = t.dlGrid;
        
        if (croppedCanvas) {
            document.getElementById('maxHint').innerText = `${t.maxHint}${croppedCanvas.width}x${croppedCanvas.height}`;
        }
    }

    const TOWN_PALETTE = [
    [5,22,22],[65,69,69],[128,130,130],[190,191,191],[254,255,255],
    [207,53,77],[238,111,114],[166,38,61],[245,172,166],[201,132,131],[163,93,94],[104,47,57],[231,213,213],[192,172,171],[117,94,94],
    [233,94,43],[249,131,88],[171,66,38],[254,186,159],[217,147,124],[175,108,88],[117,59,49],[233,213,208],[193,172,166],[117,94,89],
    [244,158,22],[254,174,59],[177,111,22],[254,206,146],[218,167,109],[179,129,75],[121,81,38],[245,228,206],[205,188,169],[128,111,94],
    [237,202,22],[249,216,56],[179,148,22],[249,230,144],[212,190,111],[171,149,75],[117,99,38],[238,231,199],[198,191,162],[120,114,89],
    [167,187,22],[182,200,51],[117,134,22],[216,223,147],[172,182,108],[133,145,75],[83,94,43],[230,233,199],[188,194,163],[110,116,93],
    [5,162,93],[65,185,123],[5,116,71],[156,218,173],[118,178,139],[79,137,105],[36,86,64],[195,224,204],[157,183,166],[83,105,93],
    [5,135,129],[5,171,160],[5,105,102],[126,205,194],[85,164,156],[43,126,120],[5,75,75],[190,224,218],[152,183,178],[78,107,102],
    [5,114,156],[5,153,186],[5,88,120],[121,187,202],[81,147,165],[36,109,127],[5,73,91],[198,221,226],[158,181,186],[79,103,111],
    [5,94,166],[43,131,193],[5,71,130],[131,168,201],[93,128,161],[54,91,127],[25,59,86],[193,205,213],[155,166,176],[76,89,103],
    [83,77,161],[117,119,189],[62,56,126],[162,160,199],[120,122,161],[85,86,126],[51,53,85],[201,202,213],[162,163,176],[86,88,105],
    [129,61,139],[161,103,169],[96,43,108],[184,155,185],[144,115,149],[108,77,115],[67,46,75],[207,201,209],[171,161,172],[96,86,100],
    [173,53,111],[207,107,143],[134,38,88],[217,161,180],[179,121,139],[139,83,103],[96,53,75],[228,213,218],[188,173,177],[114,94,102]
];

    const PALETTE_16 = [[0,0,0],[255,255,255],[255,0,0],[0,255,0],[0,0,255],[255,255,0],[0,255,255],[255,0,255],[192,192,192],[128,128,128],[128,0,0],[128,128,0],[0,128,0],[128,0,128],[0,128,128],[0,0,128]];
    let cropper, croppedCanvas, smallCanvasData, originalPixelData, warningTimer;
    const canvas = document.getElementById('mainCanvas'), ctx = canvas.getContext('2d');

    document.getElementById('upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = document.getElementById('imageToCrop');
            img.src = ev.target.result;
            if (cropper) cropper.destroy();
            document.getElementById('cropControls').style.display = 'block';
            cropper = new Cropper(img, { viewMode: 1, aspectRatio: 16/9 });
        };
        reader.readAsDataURL(file);
    });

    function setRatio(r) { cropper.setAspectRatio(r); }

    function confirmCrop() {
        croppedCanvas = cropper.getCroppedCanvas();
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'grid';
        const t = i18n[currentLang];
        document.getElementById('maxHint').innerText = `${t.maxHint}${croppedCanvas.width}x${croppedCanvas.height}`;
        safeMosaic(50, Math.round(50 * (croppedCanvas.height/croppedCanvas.width)));
    }

    function safeMosaic(tw, th) {
        if (!croppedCanvas) return;
        let finalW = Math.min(tw, croppedCanvas.width);
        let finalH = Math.min(th, croppedCanvas.height);
        if (tw > croppedCanvas.width || th > croppedCanvas.height) {
            const el = document.getElementById('limitWarning');
            el.style.opacity = '1';
            setTimeout(() => { el.style.opacity = '0'; }, 3000);
        }
        const tCanvas = document.createElement('canvas');
        tCanvas.width = finalW; tCanvas.height = finalH;
        tCanvas.getContext('2d').drawImage(croppedCanvas, 0, 0, finalW, finalH);
        smallCanvasData = tCanvas.getContext('2d').getImageData(0, 0, finalW, finalH);
        originalPixelData = new ImageData(new Uint8ClampedArray(smallCanvasData.data), finalW, finalH);
        targetColor = null;
        updateColorButtons();
        render();
    }

    function updateColorButtons() {
    const list = document.getElementById('colorPickerList');
    list.innerHTML = '';
    if (!smallCanvasData) return;

    // å»ºç«‹é¡è‰²èˆ‡ã€Œçµ„åˆ¥-åºè™Ÿã€çš„å°æ‡‰è¡¨
    const colorToId = new Map();
    TOWN_PALETTE.forEach((rgb, index) => {
        let label = "";
        if (index < 5) {
            // Group 1: 1-1 åˆ° 1-5
            label = `1-${index + 1}`;
        } else {
            // Group 2-13: 2-1 åˆ° 13-10
            const groupNum = Math.floor((index - 5) / 10) + 2;
            const itemNum = (index - 5) % 10 + 1;
            label = `${groupNum}-${itemNum}`;
        }
        colorToId.set(rgb.join(','), label);
    });

    // å–å¾—ç•«å¸ƒä¸Šç›®å‰ä½¿ç”¨çš„é¡è‰²
    const usedColors = new Set();
    for (let i = 0; i < smallCanvasData.data.length; i += 4) {
        if (smallCanvasData.data[i+3] < 128) continue;
        usedColors.add(`${smallCanvasData.data[i]},${smallCanvasData.data[i+1]},${smallCanvasData.data[i+2]}`);
    }

    // æ’åºé‚è¼¯ï¼šå°‡ç·¨è™Ÿæ‹†è§£ç‚ºæ•¸å­—é€²è¡Œæ¯”è¼ƒï¼Œç¢ºä¿ 2-2 åœ¨ 10-1 ä¹‹å‰
    const sortedColors = Array.from(usedColors).sort((a, b) => {
        const idA = colorToId.get(a) || "99-99";
        const idB = colorToId.get(b) || "99-99";
        const [gA, iA] = idA.split('-').map(Number);
        const [gB, iB] = idB.split('-').map(Number);
        return gA !== gB ? gA - gB : iA - iB;
    });

    // ç”¢ç”ŸæŒ‰éˆ•
    sortedColors.forEach(col => {
        const label = colorToId.get(col) || "?";
        const btn = document.createElement('div');
        btn.className = 'color-item' + (targetColor === col ? ' active' : '');
        btn.style.backgroundColor = `rgb(${col})`;
        btn.innerText = label; // é¡¯ç¤º 1-1, 2-5 ç­‰
        
        btn.onclick = () => {
            targetColor = col;
            updateColorButtons(); // é‡æ–°æ•´ç†æŒ‰éˆ•ç‹€æ…‹ (æ¨™è¨» active)
            render();
        };
        list.appendChild(btn);
    });
}

    function filterColor(col) {
        targetColor = col;
        updateColorButtons();
        render();
    }

    function applyCustom() {
        const w = parseInt(document.getElementById('customW').value);
        const h = parseInt(document.getElementById('customH').value);
        if (w > 0 && h > 0) safeMosaic(w, h);
    }

    function resetColors() {
        if (!originalPixelData) return;
        smallCanvasData.data.set(originalPixelData.data);
        targetColor = null;
        updateColorButtons();
        render();
    }

    function applyPalette(mode, dither) {
        resetColors();
        const data = smallCanvasData.data;
        const w = smallCanvasData.width, h = smallCanvasData.height;
        for (let y = 0; y < h; y++) {
            for (let x = 0; x < w; x++) {
                const i = (y * w + x) * 4;
                const r = data[i], g = data[i+1], b = data[i+2];
                let n;
                if(mode === 'town') n = getNear(r, g, b, TOWN_PALETTE);
                else if(mode === '16') n = getNear(r, g, b, PALETTE_16);
                else n = [Math.round(r/51)*51, Math.round(g/51)*51, Math.round(b/51)*51];
                data[i] = n[0]; data[i+1] = n[1]; data[i+2] = n[2];
                if (dither) {
                    const er = r - n[0], eg = g - n[1], eb = b - n[2];
                    dist(data, x+1, y, w, h, er, eg, eb, 7/16);
                    dist(data, x-1, y+1, w, h, er, eg, eb, 3/16);
                    dist(data, x, y+1, w, h, er, eg, eb, 5/16);
                    dist(data, x+1, y+1, w, h, er, eg, eb, 1/16);
                }
            }
        }
        updateColorButtons();
        render();
    }

    function getNear(r, g, b, pal) {
        let m = Infinity, bst = pal[0];
        for (const c of pal) {
            const d = (r-c[0])**2 + (g-c[1])**2 + (b-c[2])**2;
            if (d < m) { m = d; bst = c; }
        }
        return bst;
    }

    function dist(data, x, y, w, h, er, eg, eb, wt) {
        if (x < 0 || x >= w || y >= h) return;
        const i = (y * w + x) * 4;
        data[i] += er * wt; data[i+1] += eg * wt; data[i+2] += eb * wt;
    }

    function render() {
        if (!smallCanvasData) return;
        const w = smallCanvasData.width, h = smallCanvasData.height;
        const scale = Math.floor(Math.min(700/w, 600/h)) || 1;
        canvas.width = w * scale; canvas.height = h * scale;
        ctx.imageSmoothingEnabled = false;
        
        const tempData = new ImageData(new Uint8ClampedArray(smallCanvasData.data), w, h);
        if (targetColor) {
            const rgb = targetColor.split(',').map(Number);
            for (let i = 0; i < tempData.data.length; i += 4) {
                if (tempData.data[i] !== rgb[0] || tempData.data[i+1] !== rgb[1] || tempData.data[i+2] !== rgb[2]) {
                    tempData.data[i+3] = 0;
                }
            }
        }

        const tCanvas = document.createElement('canvas');
        tCanvas.width = w; tCanvas.height = h;
        tCanvas.getContext('2d').putImageData(tempData, 0, 0);
        ctx.drawImage(tCanvas, 0, 0, w, h, 0, 0, canvas.width, canvas.height);
        
        if (document.getElementById('showGrid').checked) {
            ctx.beginPath();
            for(let x=0; x<=w; x++) {
                const posX = x * scale;
                ctx.moveTo(posX, 0); ctx.lineTo(posX, canvas.height);
                ctx.lineWidth = (x % 5 === 0 || x === w) ? 2.5 : 1.5;
                ctx.strokeStyle = (x % 5 === 0 || x === w) ? "rgba(0,0,0,0.5)" : "rgba(0,0,0,0.25)";
                ctx.stroke(); ctx.beginPath();
            }
            for(let y=0; y<=h; y++) {
                const posY = (h - y) * scale;
                ctx.moveTo(0, posY); ctx.lineTo(canvas.width, posY);
                ctx.lineWidth = (y % 5 === 0 || y === h) ? 2.5 : 1;
                ctx.strokeStyle = (y % 5 === 0 || y === h) ? "rgba(0,0,0,0.5)" : "rgba(0,0,0,0.25)";
                ctx.stroke(); ctx.beginPath();
            }
        }
    }

    function downloadImage(withGrid) {
    if (!smallCanvasData) return;
    const w = smallCanvasData.width, h = smallCanvasData.height;
    
    // è¨­å®šæ”¾å¤§å€ç‡ï¼š10å€æ˜¯å…¼é¡§æª”æ¡ˆå¤§å°èˆ‡æ‰‹æ©Ÿæ¸…æ™°åº¦çš„é»ƒé‡‘æ¯”ä¾‹
    const upscaleFactor = 10; 
    const outCanvas = document.createElement('canvas');
    
    // å¦‚æœæœ‰ç¶²æ ¼ï¼Œç‚ºäº†è®“ç·šæ¢å¥½çœ‹ï¼Œæˆ‘å€‘å¯ä»¥ç¨å¾®å†æ”¾å¤§ä¸€é»æˆ–ç¶­æŒ 10 å€
    const drawScale = upscaleFactor;
    outCanvas.width = w * drawScale;
    outCanvas.height = h * drawScale;
    const outCtx = outCanvas.getContext('2d');

    // ã€é—œéµã€‘é—œé–‰å¹³æ»‘åŒ–ï¼Œå¯¦ç¾ç„¡ææ”¾å¤§
    outCtx.imageSmoothingEnabled = false;

    // 1. ç¹ªè£½åƒç´ åº•åœ–
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = w; tempCanvas.height = h;
    tempCanvas.getContext('2d').putImageData(smallCanvasData, 0, 0);
    
    // å°‡å°åœ–æ‹‰ä¼¸åˆ°å¤§ç•«å¸ƒä¸Š
    outCtx.drawImage(tempCanvas, 0, 0, w, h, 0, 0, outCanvas.width, outCanvas.height);

    // 2. å¦‚æœéœ€è¦ç¶²æ ¼ï¼Œåœ¨é«˜è§£æåº¦ç•«å¸ƒä¸Šé‡æ–°ç¹ªè£½
    if (withGrid) {
        outCtx.beginPath();
        for(let x=0; x<=w; x++) {
            outCtx.moveTo(x * drawScale, 0);
            outCtx.lineTo(x * drawScale, outCanvas.height);
            outCtx.lineWidth = (x % 5 === 0) ? 3 : 1; // ç²—ç´°å°æ¯”
            outCtx.strokeStyle = "rgba(0,0,0,0.4)";
            outCtx.stroke();
            outCtx.beginPath();
        }
        for(let y=0; y<=h; y++) {
            outCtx.moveTo(0, (h - y) * drawScale);
            outCtx.lineTo(outCanvas.width, (h - y) * drawScale);
            outCtx.lineWidth = (y % 5 === 0) ? 3 : 1;
            outCtx.strokeStyle = "rgba(0,0,0,0.4)";
            outCtx.stroke();
            outCtx.beginPath();
        }
    }

    // åŸ·è¡Œä¸‹è¼‰
    const link = document.createElement('a');
    link.download = withGrid ? `TownArt_Grid_${w}x${h}.png` : `TownArt_Sharp_${w}x${h}.png`;
    link.href = outCanvas.toDataURL('image/png');
    link.click();
}
</script>
</body>
</html>
